<!DOCTYPE html>
<html lang="en">
<head>
    <html lang="en">
  <head>
    <title>
      R data.table Best Practices
    </title>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name='author' content='Michael Wang Fei'>
    <meta name='keywords' content='
          machine learning,
          statistical machine learning,
          bayesian inference,
          statistics,
          computational statistics,
          linear algebra,
          numerical linear algebra,
          statistical software,
          deep learning,
          computer science,
          probability,
          math,
          mathematics,
          probabilistic reasoning
      '>
      <meta name='keywords' content='data-science, data-analysis, data-table, r-programming'>
      <link rel="stylesheet" href="/css/blog.css">
      <link rel="stylesheet" href="/css/markdown.css">
      <link rel="stylesheet" href="/css/trac.css">
      <link rel="shortcut icon" type="image/png" href="/images/favicon.png">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
      <!-- The loading of KaTeX is deferred to speed up page rendering -->
      <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
      <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
      <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>R data.table Best Practices</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="R data.table Best Practices" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I have been planning to write a post on data.table for a while. The motivation is that many posts on data science or data analysis in R are using data.frame or dplyr to manipulate data. Many people probably will go for pandas in Python in the first place. However, I appreciate the efficiency of data.table more and more now, and believe for the dataset with is larger than 1GB and less than 100GB, data.table is the best choice." />
<meta property="og:description" content="I have been planning to write a post on data.table for a while. The motivation is that many posts on data science or data analysis in R are using data.frame or dplyr to manipulate data. Many people probably will go for pandas in Python in the first place. However, I appreciate the efficiency of data.table more and more now, and believe for the dataset with is larger than 1GB and less than 100GB, data.table is the best choice." />
<link rel="canonical" href="https://oceanumeric.github.io//blog/r-data-table-best-practices" />
<meta property="og:url" content="https://oceanumeric.github.io//blog/r-data-table-best-practices" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="R data.table Best Practices" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-23T00:00:00+00:00","datePublished":"2023-04-23T00:00:00+00:00","description":"I have been planning to write a post on data.table for a while. The motivation is that many posts on data science or data analysis in R are using data.frame or dplyr to manipulate data. Many people probably will go for pandas in Python in the first place. However, I appreciate the efficiency of data.table more and more now, and believe for the dataset with is larger than 1GB and less than 100GB, data.table is the best choice.","headline":"R data.table Best Practices","mainEntityOfPage":{"@type":"WebPage","@id":"https://oceanumeric.github.io//blog/r-data-table-best-practices"},"url":"https://oceanumeric.github.io//blog/r-data-table-best-practices"}</script>
<!-- End Jekyll SEO tag -->

  </head>
</html>


</head>
<body>
<div class='content'>
    <!DOCTYPE html>
<div class='nav'>
    <ul class='wrap'>
        <li><a href='/'>Home</a></li>
        <li><a href='/blog'>Blog</a></li>
        <li><a href='/math'>Math</a></li>
        <li><a href='/tags'>Tags</a></li>
    </ul>
</div>
</html>

    <div class='front-matter'>
        <div class='wrap'>
            <h1>R data.table Best Practices</h1>
            <h4>There are many packages in R or Python to deal with table like data (or so called data frame), but data.table is probably the most efficient one. Here are some best practices to use data.table.</h4>
            <div class='bylines'>
                <div class='byline'>
                    
                    
                        <span class="post-tags">
                            <i class="fa fa-tags"></i>
                            
                            <a href="/blog-tags/data-science">data-science,</a>, 
                            
                            <a href="/blog-tags/r">r</a>
                            
                        </span>
                    
                    <h3>Published</h3>
                    <p>23 April 2023</p>
                </div>
            </div>
            <div class='clear'></div>
        </div>
    </div>
    <div class='wrap article'>
        <p>I have been planning to write a post on <code class="language-plaintext highlighter-rouge">data.table</code> for a while. The motivation is that
many posts on data science or data analysis in R are using <code class="language-plaintext highlighter-rouge">data.frame</code> or <code class="language-plaintext highlighter-rouge">dplyr</code> to
manipulate data. Many people probably will go for <code class="language-plaintext highlighter-rouge">pandas</code> in Python in the first place.
However, I appreciate the efficiency of <code class="language-plaintext highlighter-rouge">data.table</code> more and more now, and believe for the dataset with is larger than 1GB and less than 100GB, <code class="language-plaintext highlighter-rouge">data.table</code> is the best choice.</p>

<p>After many years of using both <code class="language-plaintext highlighter-rouge">Python</code> and <code class="language-plaintext highlighter-rouge">R</code>, I have found that <code class="language-plaintext highlighter-rouge">data.table</code> is the most efficient package to deal with table-like data. It is also the most efficient package to deal with large dataset in <code class="language-plaintext highlighter-rouge">R</code>.</p>

<p>I also realized that there are many posts on the internet teaching people how to use all
kinds of packages in <code class="language-plaintext highlighter-rouge">R</code>, especially <code class="language-plaintext highlighter-rouge">tidyverse</code>. First of all, I have to say
that I like <code class="language-plaintext highlighter-rouge">dtidyverse</code> a lot, especially <code class="language-plaintext highlighter-rouge">ggplot2</code> and <code class="language-plaintext highlighter-rouge">dplyr</code>. However, I think
using <code class="language-plaintext highlighter-rouge">data.table</code> with basic <code class="language-plaintext highlighter-rouge">R</code> syntax is more efficient than using different kinds 
of packages. I believe using <code class="language-plaintext highlighter-rouge">data.table</code> with basic <code class="language-plaintext highlighter-rouge">R</code> syntax very well is the best
way to learn <code class="language-plaintext highlighter-rouge">R</code> for data analysis.</p>

<p>So, here are the messages I have learned from my experience:</p>

<ul>
  <li>Use <code class="language-plaintext highlighter-rouge">Excel</code> for small dataset, such as less than 100MB (it is probably already too large for <code class="language-plaintext highlighter-rouge">Excel</code>).</li>
  <li>Use <code class="language-plaintext highlighter-rouge">data.table</code> with basic <code class="language-plaintext highlighter-rouge">R</code> syntax for any dataset in the format of table-like or data-frame between 100MB and 100GB.</li>
  <li>Use <code class="language-plaintext highlighter-rouge">Python</code> for any dataset that is not structured in the format of table-like or data-frame.</li>
  <li>Use basic <code class="language-plaintext highlighter-rouge">R</code> syntax for data visualization and only use <code class="language-plaintext highlighter-rouge">ggplot2</code> when you need to do some advanced visualization.</li>
  <li>Use <code class="language-plaintext highlighter-rouge">Python</code> for machine learning and deep learning projects.</li>
  <li>Use <code class="language-plaintext highlighter-rouge">R</code> for statistical analysis and data analysis projects in finance, economics, and other fields.</li>
  <li>Keep trying different packages and learn from others, such as <code class="language-plaintext highlighter-rouge">Polars</code>.</li>
</ul>

<p>If you do not believe me why I think <code class="language-plaintext highlighter-rouge">data.table</code> is the efficient one, please  check the <a href="https://duckdblabs.github.io/db-benchmark/" target="_blank">benchmark</a> of different packages on data manipulation.</p>

<p>Here is the roadmap of this post:</p>

<ul>
  <li><a href="#big-picture">Big picture</a></li>
  <li><a href="#best-practices">Best practices</a></li>
</ul>

<h2 id="big-picture">Big picture</h2>

<p>Broadly speaking, there are there kinds of tasks in data analysis:</p>

<ol>
  <li>what is the data about? such as the data structure, the data type, the data size, and variable names, etc.</li>
  <li>the data manipulation, such as data cleaning, data transformation, data aggregation, and data merging, etc.</li>
  <li>the data analysis, such as data visualization, statistical analysis, and machine learning, etc.</li>
</ol>

<p>I will use a small dataset to illustrate the best practices for each task. One could use those best practices to deal with any dataset in the format of table-like or data-frame
even if the dataset is very large (e.g., 100GB).</p>

<p>All code in this post uses <code class="language-plaintext highlighter-rouge">%&gt;%</code> from <code class="language-plaintext highlighter-rouge">magrittr</code> package heavily, which is a very useful package to chain functions together. The pipe operator <code class="language-plaintext highlighter-rouge">%&gt;%</code> in <code class="language-plaintext highlighter-rouge">R</code> community is one of the most important features in <code class="language-plaintext highlighter-rouge">R</code>, which makes me to favor <code class="language-plaintext highlighter-rouge">R</code> over <code class="language-plaintext highlighter-rouge">Python</code> in data analysis for table-like data.</p>

<p>Before we start, you need to understand that table-like data is a two dimensional data structure, which is also called data frame in <code class="language-plaintext highlighter-rouge">R</code> or <code class="language-plaintext highlighter-rouge">Python</code>. The first dimension is the row dimension, and the second dimension is the column dimension. The row dimension is the observation dimension, and the column dimension is the variable dimension. Figure 
1 illustrates how <code class="language-plaintext highlighter-rouge">data.table</code> manupulates data in the row dimension and the column dimension with the syntax of <code class="language-plaintext highlighter-rouge">i</code> and <code class="language-plaintext highlighter-rouge">j</code>.</p>

<div class="figure">
    <img src="/images/blog/R-data-table-illustration.png" alt="fp7 totalcost hist1" class="zoom-img" style="width: 76%; display: block; margin: 0 auto;" />
    <div class="caption">
        <span class="caption-label">Figure 1.</span> The illustration of LDA from the paper by David Blei (2012). You can click on the image to zoom in.
    </div>
</div>

<h2 id="best-practices">Best practices</h2>

<p>Let’s import key packages and load the dataset. When you do a project, it is better 
to use as less packages as possible because it is easier to debug and maintain the code.
If you have too many packages, the dependencies of the packages may conflict with each other and it also makes the code harder to maintain and debug.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">data.table</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">knitr</span><span class="p">)</span><span class="w">  </span><span class="c1"># for kable, a function to print a table in different formats</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">  </span><span class="c1"># only use it for advanced visualization</span><span class="w">
</span><span class="c1"># for dplyr, it is recommended to call it as dplyr::filter, dplyr::select, etc.</span><span class="w">
</span></code></pre></div></div>

<p>The dataset we will use is based on a survey I did for one of my tutorials. Here is
the <a href="https://docs.google.com/forms/d/1VoDT0dknxvx1T_RDILHOYvLH226ZCFMhkUuRtJvyT60/edit" target="_blank">link</a> to the survey.
It has 10 questions and the answers are in the format of single choice, multiple 
choices, and open answers. The dataset is in the format of table-like data, which is
stored in a <a href="https://raw.githubusercontent.com/oceanumeric/data-science-go-small/main/Tutorial_01/survey_responses.csv" target="_blank">csv file</a>. I added duplicated rows to the dataset as an example of how to deal with duplicated rows.</p>

<h3 id="structure-of-the-data-the-first-step">structure of the data: the first step</h3>

<p>Every time I got a new dataset, I use three functions to check the structure of the data: <code class="language-plaintext highlighter-rouge">head</code>, <code class="language-plaintext highlighter-rouge">str</code>, and <code class="language-plaintext highlighter-rouge">summary</code>. The <code class="language-plaintext highlighter-rouge">head</code> function prints the first 6 rows of the dataset. The <code class="language-plaintext highlighter-rouge">str</code> function prints the structure of the dataset, which includes the data type of each variable. The <code class="language-plaintext highlighter-rouge">summary</code> function prints the summary statistics of each variable.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># read data</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fread</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/oceanumeric/data-science-go-small/main/Tutorial_01/survey_responses.csv"</span><span class="p">)</span><span class="w">


</span><span class="c1"># data structure</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w">  </span><span class="c1"># 24 observations of 11 variables</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w">  </span><span class="c1"># check the first 6 rows</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="missing-values-are-always-tricky">missing values are always tricky</h3>

<p>To check how many missing values are in the dataset, we can use the <code class="language-plaintext highlighter-rouge">is.na</code> function. The <code class="language-plaintext highlighter-rouge">is.na</code> function returns a logical vector with the same length as the dataset. Combining the <code class="language-plaintext highlighter-rouge">is.na</code> function with <code class="language-plaintext highlighter-rouge">sum</code> and <code class="language-plaintext highlighter-rouge">sapply</code> functions, we can check how many missing values are in each variable.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">########## --------- check missing values --------- ###########</span><span class="w">

</span><span class="c1"># Missing values are tricky as they can be represented in different ways</span><span class="w">
</span><span class="c1"># such as "", "Na", "NA", "na", "N/A", "n/a", "NA/NaN", "NA/NaN/Na", etc.</span><span class="w">

</span><span class="c1"># check missing values and print it as a table</span><span class="w">
</span><span class="n">sapply</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">kable</span><span class="p">()</span><span class="w">

</span><span class="c1"># there is only one missing value in q2?</span><span class="w">
</span><span class="n">sapply</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="s2">""</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">kable</span><span class="p">()</span><span class="w">
</span><span class="n">sapply</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Na"</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">kable</span><span class="p">()</span><span class="w">

</span><span class="n">sapply</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">kable</span><span class="p">()</span><span class="w">
</span><span class="n">sapply</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Na"</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">kable</span><span class="p">()</span><span class="w">

</span><span class="c1"># replace missing values (represented as strings) with NA</span><span class="w">
</span><span class="n">dt</span><span class="p">[</span><span class="n">dt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">""</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">
</span><span class="n">dt</span><span class="p">[</span><span class="n">dt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Na"</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NA</span><span class="w">

</span><span class="n">sapply</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">kable</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<h3 id="column-transformation">column transformation</h3>

<p>As it is shown in Figure 1, all column operations are done in the <code class="language-plaintext highlighter-rouge">j</code> part of the <code class="language-plaintext highlighter-rouge">data.table</code> syntax.</p>

<p>The <code class="language-plaintext highlighter-rouge">data.table</code> package provides a very efficient way to manipulate data in the column dimension. The <code class="language-plaintext highlighter-rouge">:=</code> operator is used to create a new variable. The <code class="language-plaintext highlighter-rouge">:=</code> operator is very similar to the <code class="language-plaintext highlighter-rouge">=</code> operator in <code class="language-plaintext highlighter-rouge">R</code>. The difference is that the <code class="language-plaintext highlighter-rouge">:=</code> operator does not create a new copy of the dataset. The <code class="language-plaintext highlighter-rouge">:=</code> operator modifies the dataset in place, which means doing operations on the original dataset.</p>

<p>If you do not want to modify the original dataset, you can use <code class="language-plaintext highlighter-rouge">.()</code> to create a new copy of the dataset. One could also use <code class="language-plaintext highlighter-rouge">c(column_name)</code> to create a new copy of the dataset.</p>

<p>In summary, here are ways to select and manipulate columns in <code class="language-plaintext highlighter-rouge">data.table</code>:</p>

<ul>
  <li>return a new copy of the dataset:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dt[, .(variable_name1, variable_name2)]</code></li>
      <li><code class="language-plaintext highlighter-rouge">dt[, c(1, 2, 3:7)]</code> select the first, second, and the third to the seventh columns</li>
    </ul>
  </li>
  <li>return a vector of the column:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dt[, variable_name]</code></li>
      <li><code class="language-plaintext highlighter-rouge">dt %&gt;% .[, (variable_name)]</code> the dot <code class="language-plaintext highlighter-rouge">.</code> represents the dataset</li>
    </ul>
  </li>
  <li>Create new variable in place (on original dataset)
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dt[, new_variable_name := expression]</code></li>
      <li><code class="language-plaintext highlighter-rouge">dt %&gt;% .[, new_variable_name := expression]</code> the dot <code class="language-plaintext highlighter-rouge">.</code> represents the dataset</li>
    </ul>
  </li>
  <li>Create new variable in a new copy of the dataset
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dt[, .(new_variable_name = expression)]</code></li>
      <li><code class="language-plaintext highlighter-rouge">dt %&gt;% .[, .(new_variable_name = expression)]</code> the dot <code class="language-plaintext highlighter-rouge">.</code> represents the dataset</li>
    </ul>
  </li>
</ul>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">########## --------- column operations --------- ###########</span><span class="w">

</span><span class="c1"># check structure of dt again</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="w">

</span><span class="c1"># convert timeStamp to date format by adding a new column</span><span class="w">
</span><span class="c1"># called dateTime to dt</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">dateTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">as.POSIXct</span><span class="p">(</span><span class="n">timesStamp</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"%m/%d/%Y %H:%M:%S"</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># create a new column called year</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="n">dateTime</span><span class="p">,</span><span class="w"> </span><span class="s2">"%Y"</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1"># you can also convert it to numeric</span><span class="w">
    </span><span class="c1"># .[, year := as.numeric(format(dateTime, "%Y"))] %&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># select columns and return a new data.table</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">q2</span><span class="p">,</span><span class="w"> </span><span class="n">q3</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># select q9: 9. Did you try ChatGPT? </span><span class="w">
</span><span class="c1"># convert it to lower case</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">q9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tolower</span><span class="p">(</span><span class="n">q9</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># select columns year, and from q3 to q10</span><span class="w">
</span><span class="c1"># one needs to know the column index</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="o">:</span><span class="m">11</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># return a vector</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="p">(</span><span class="n">q7</span><span class="p">)]</span><span class="w">
</span></code></pre></div></div>

<p>Sometimes, we want to do operations on multiple columns based on their names. 
For instance, we want to select all columns with names starting with <code class="language-plaintext highlighter-rouge">q</code>. For this,
we can use <code class="language-plaintext highlighter-rouge">.SDcols</code> to select columns based on their names. The <code class="language-plaintext highlighter-rouge">.SDcols</code> is a
special variable in <code class="language-plaintext highlighter-rouge">data.table</code> that represents the selected columns. <code class="language-plaintext highlighter-rouge">SD</code> stands
for Subset of Data.</p>

<p>By combing <code class="language-plaintext highlighter-rouge">.SDcols</code> with <code class="language-plaintext highlighter-rouge">.SD</code>, we can:</p>

<ul>
  <li>select columns based on their names
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dt[, .SD, .SDcols = c("q1", "q2", "q3")]</code></li>
      <li><code class="language-plaintext highlighter-rouge">dt[, .SD, .SDcols = c(1, 2, 3)]</code></li>
      <li><code class="language-plaintext highlighter-rouge">dt[, .SD, .SDcols = patterns("^q")]</code> select columns with names starting with “q”</li>
    </ul>
  </li>
  <li>do operations on the selected columns
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dt[, lapply(.SD, mean), .SDcols = c("q1", "q2", "q3")]</code> compute the mean of columns q1, q2, and q3</li>
      <li><code class="language-plaintext highlighter-rouge">dt[, lapply(.SD, tolower), .SDcols = c(1, 2, 3)]</code> convert all columns to lower case</li>
      <li><code class="language-plaintext highlighter-rouge">dt[, lapply(.SD, mean), .SDcols = patterns("^q")]</code></li>
    </ul>
  </li>
</ul>

<p>I provide four examples below to show how to select columns based on different criteria.</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># select columns with names starting with "q"</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.SD</span><span class="p">,</span><span class="w"> </span><span class="n">.SDcols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grep</span><span class="p">(</span><span class="s2">"^q"</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">dt</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># or using patterns to select columns</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.SD</span><span class="p">,</span><span class="w"> </span><span class="n">.SDcols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">patterns</span><span class="p">(</span><span class="s2">"^q"</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># we can also do operations on multiple columns</span><span class="w">

</span><span class="c1"># select columns based on their data types == int</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.SD</span><span class="p">,</span><span class="w"> </span><span class="n">.SDcols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is.integer</span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">str</span><span class="p">()</span><span class="w">

</span><span class="c1"># convert values from q2 to q10 to lower case if they are characters</span><span class="w">
</span><span class="c1"># return a new data.table</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.SD</span><span class="p">,</span><span class="w"> </span><span class="n">.SDcols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is.character</span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">.SD</span><span class="p">,</span><span class="w"> </span><span class="n">tolower</span><span class="p">),</span><span class="w"> </span><span class="n">.SDcols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">patterns</span><span class="p">(</span><span class="s2">"^q"</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">str</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>I believe the above code covers most of the common operations in data transformation in terms of selecting columns. For columns, we have two
properties: <em>names and data types</em>. We can select columns based on their names or data types, or both by using <code class="language-plaintext highlighter-rouge">%&gt;%</code> to chain multiple operations.</p>

<h3 id="row-transformation">row transformation</h3>

<p>When we talk about row operations, we have two properties: <em>row indices and row values</em>. Based on those two properties, we can:</p>

<ul>
  <li>operate on <em>row values</em> without any row indices, which means passing
the all values in one row to a function.</li>
  <li>operate on <em>row values</em> with row indices, which means
    <ul>
      <li>we filter the dataset based on some criteria</li>
      <li>we subset the dataset based on row indices or some criteria</li>
    </ul>
  </li>
</ul>

<p>When we do operations on row values, we will use <code class="language-plaintext highlighter-rouge">with</code> heavily in the pipeline as it could help us to do:</p>

<ol>
  <li>call functions on the row values within pipelines</li>
  <li>call basic plotting functions on the row values within pipelines</li>
</ol>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># one row operation, without any row indices</span><span class="w">
</span><span class="c1"># summarize q1 - chr, yes, no</span><span class="w">
</span><span class="c1"># treat it as factor, using table() to count the number of each level</span><span class="w">

</span><span class="n">table</span><span class="p">(</span><span class="n">dt</span><span class="o">$</span><span class="n">q1</span><span class="p">)</span><span class="w">

</span><span class="c1"># or convert it to factor first</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">table</span><span class="p">()</span><span class="w"> 

</span><span class="c1"># better presentation</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">kable</span><span class="p">()</span><span class="w">

</span><span class="c1"># calculate the percentage of each level</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">share</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">count.N</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">count.N</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">kable</span><span class="p">()</span><span class="w">

</span><span class="c1"># plot it as a bar chart</span><span class="w">
</span><span class="c1"># set options for the size</span><span class="w">
</span><span class="n">options</span><span class="p">(</span><span class="n">repr.plot.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">repr.plot.height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">with</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">q1</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">barplot</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Did you learn regression model before?"</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot share instead of count</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">with</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">barplot</span><span class="p">(</span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Did you learn regression model before?"</span><span class="p">)</span><span class="w">


</span><span class="c1"># more advanced visualization with ggplot2</span><span class="w">
</span><span class="n">dt</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">.</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table</span><span class="p">(</span><span class="n">q1</span><span class="p">))]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">.</span><span class="p">[,</span><span class="w"> </span><span class="n">share</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">count.N</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">count.N</span><span class="p">)]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">ggplot</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">count.q1</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">share</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_col</span><span class="p">(</span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"#6F6CAE"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">share</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">)),</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
    </span><span class="n">labs</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Did you learn regression model before?"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

    </div>
    <div id='bibliography'>
        <div class='wrap'>
            <ol class="bibliography"></ol>
        </div>
    </div>
</div>
<!-- back-to-top button from Mkdocs material -->
<a
href="#"
id="back-top"
aria-label="Back-to-top link"
style="
position: fixed;
bottom: 10%;
margin-left:85%;
color: #808080;
background-color: #FFFFFF;"
hidden
>
<img width="30px" height="30px" alt="up-arrow" src="/images/up-arrow.png">
</a>

<script src="/assets/js/codeCopy.js"></script>
<script src="/assets/js/backTotop.js"></script>
<script>
    var lis = document.getElementsByClassName("footnotes")
    for (let i = 0; i < lis.length; i++){
        var li_tag = lis[i].getElementsByTagName('li')
    
        for (let j = 0; j < li_tag.length; j++) {
            li_tag[j].setAttribute('role', 'link')
        }
        var a_tag = lis[i].getElementsByTagName('a')
    
        for (let k = 0; k < a_tag.length; k++) {
            a_tag[k].setAttribute('role', 'link')
        }
    }
    </script>
    <style>
        .zoom-img{
            display: block;
            height: auto;
            transition: transform ease-in-out 0.7s;
            cursor: zoom-in;
        }
        .image-zoom-scale{
            transform: scale(1.7);
            cursor: zoom-out;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            z-index: 100;
            position: relative;
        }
    </style>
    <script>
        document.querySelectorAll('.zoom-img').forEach(item => {
        item.addEventListener('click', function () {
            this.classList.toggle('image-zoom-scale');
        })
        });
    </script>
</body>
</html>